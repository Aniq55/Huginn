*** Settings ***
#Suite Setup    Start Huginn
#Suite Teardown    Stop Huginn
Test Setup    Start Huginn
Test Teardown    Stop Huginn
Library    Collections
Library    RequestsLibrary
Resource    Huginn.robot

*** Test Cases ***
Simulator endpoint returns the simulator status
    [Documentation]    This test checks if the simulator endpoint returns the simulator status
    [Tags]    api    simulator
    Create Session    huginn_web_server  ${HUGINN_URL}
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} > 0.00625

Resume the simulation after the simulator has started
    [Documentation]    This test checks if the simulator will respond to the resume command
    [Tags]    api    simulator
    Create Session    huginn_web_server  ${HUGINN_URL}
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} < 2.0
    ${resp} =    Execute Simulator Control Command    huginn_web_server  resume
    Simulator Command Executed Successfully    ${resp}  resume
    Sleep    2 seconds
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} > 2.0

Check if the simulator is reset properly
    [Documentation]    This test checks if the simulator will reset properly
    [Tags]    api    simulator
    Create Session    huginn_web_server  ${HUGINN_URL}
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} < 2.0
    ${resp} =    Execute Simulator Control Command    huginn_web_server  resume
    Simulator Command Executed Successfully    ${resp}  resume
    Sleep    2 seconds
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} > 2.0
    ${resp} =    Execute Simulator Control Command    huginn_web_server  reset
    Simulator Command Executed Successfully    ${resp}  reset
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} < 2.0
    ${resp} =    Get Request    huginn_web_server  /aircraft/gps
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  latitude
    JSON Response Should Contain item    ${resp}  longitude
    JSON Response Should Contain item    ${resp}  altitude
    JSON Response Should Contain item    ${resp}  airspeed
    JSON Response Should Contain item    ${resp}  heading
    Value Close To    ${resp.json()['latitude']}  37.923255  0.001
    Value Close To    ${resp.json()['longitude']}  23.921773  0.001
    Value Close To    ${resp.json()['altitude']}  300.00000  10.0
    Value Close To    ${resp.json()['airspeed']}  30.00000  5.0
    Value Close To    ${resp.json()['heading']}  45.00000  5.0

Pause the simulator
    [Documentation]    This test checks if the simulator can be paused
    [Tags]    api    simulator
    Create Session    huginn_web_server  ${HUGINN_URL}
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} < 2.0
    ${resp} =    Execute Simulator Control Command    huginn_web_server  resume
    Simulator Command Executed Successfully    ${resp}  resume
    Sleep    2 seconds
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} > 2.0
    ${resp} =    Execute Simulator Control Command    huginn_web_server  pause
    Simulator Command Executed Successfully    ${resp}  pause
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    Should Be Equal As Numbers    ${resp.json()['dt']}  0.00625
    Should Not Be True    ${resp.json()['running']}
    Should Be True    ${resp.json()['time']} > 2.0

Run a single simulation step
    [Documentation]    This test checks if the simulator can run a single step
    [Tags]    api    simulator
    Simulator is Paused
    Create Session    huginn_web_server  ${HUGINN_URL}
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    ${dt} =    Convert To Number    ${resp.json()['dt']}
    Should Be Equal As Numbers    ${dt}  0.00625
    ${running} =    Convert To Boolean    ${resp.json()['running']}
    Should Not Be True    ${running}
    ${time} =    Convert To Number    ${resp.json()['time']}
    Should Be True    ${time} < 2.0
    ${last_run_time} =    Set Variable    ${resp.json()['time']}
    ${last_run_time} =    Convert To Number    ${last_run_time}
    ${resp} =    Execute Simulator Control Command    huginn_web_server  step
    Simulator Command Executed Successfully    ${resp}  step
    ${resp} =    Get Request    huginn_web_server  /simulator
    Should be Equal As Strings    ${resp.status_code}  200
    Response Content Type Should Be JSON    ${resp}
    JSON Response Should Contain item    ${resp}  dt
    JSON Response Should Contain item    ${resp}  running
    JSON Response Should Contain item    ${resp}  time
    ${dt} =    Convert To Number    ${resp.json()['dt']}
    Should Be Equal As Numbers    ${dt}  0.00625
    ${running} =    Convert To Boolean    ${resp.json()['running']}
    Should Not Be True    ${running}
    ${time} =    Convert To Number    ${resp.json()['time']}
    Should Be Equal    ${time}  ${last_run_time + 0.00625}
